<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, target-densitydpi=device-dpi, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="screen-orientation" content="portrait">
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">
	<title>购买结果</title>
	<script src="https://i3.yongche.name/media/g4/M04/00/21/rBEDBVsaXZOIZtJ1AAAPg6xQb3EAAAM_gBNCnkAAA-b7128.js"></script>
	<!--<link rel="stylesheet" href="https://cdn.bootcss.com/Swiper/4.1.0/css/swiper.min.css">-->
	<link href="<{asset2:js/app/swiper/swiper3.07.min.css}>" rel="stylesheet">
	<style>
[v-cloak] {display: none;}
html, body { position: relative; height: 100%;}
body { font-family: Helvetica Neue, Helvetica, Arial, sans-serif; color:#000; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body,ul,li,p,span,div,a,img,section{ margin: 0; padding: 0; box-sizing: border-box; border:0; outline:0;}
ul,li{ list-style: none;} 
a{ text-decoration: none; }
p{ text-indent:0;}
.fl{float: left;}
.fr{float: right;}
/*清除浮动代码*/
.clearfix:after{display:block;clear:both;content:"";visibility:hidden;height:0}
.clearfix{zoom:1}   
/*toast提示*/
.toastmsg{ position: fixed; bottom: 6.08rem; width: 100%;}
.toastmsg .toasttext{ margin: 0 auto; width: 5.26rem;line-height: 0.8rem; background: rgba(0,0,0,0.75); color: #fff; z-index: 30; text-align: center; border-radius: 0.08rem;font-size: 0.3rem;height: 0.8rem;}
.slide-up-fade-enter-active { transition: all .3s ease; }
.slide-up-fade-leave-active { transition: all .3s cubic-bezier(1.0, 0.5, 0.8, 1.0); }
.slide-up-fade-enter , .slide-up-fade-leave-to { transform: translateY(100px); opacity: 0; }
/*公用弹层背景*/
.mask{ position: absolute; top:0; bottom: 0; left:0; right: 0; z-index: 9999; width: 100%; height:100%; background-color: #f0f0f0;}

#app{ position: relative;height: 100%;min-height: 10.0rem; background: #F5F5F5;}	
.container{ position: relative;height: 100%;}
.inner-main{ position: absolute; top: 0; bottom: 1.36rem; width: 100%; overflow-y: auto; }

.inner-main .whitebg{ background: #FFFFFF; padding-top: 0.6rem; }
.inner-main .result-wrapper{ margin-bottom: 0.34rem; }
.inner-main .result-wrapper .result-title{ margin: 0 auto 0.12rem; padding-left: 0.76rem; width: 2.4rem; height: 0.56rem; font-size: 0.4rem; line-height: 0.56rem; color: #323232; text-align: center; font-weight: 600; background: url('https://i3.yongche.name/media/g2/M01/1C/22/rBEBP1qObo6IH9yLAAAWCt-Zht4AALGugLzUBIAABYi607.png') no-repeat;  background-size: 0.56rem;  }
.inner-main .result-wrapper .result-subtitle{ font-size:0.28rem; line-height: 0.4rem; color: #646464; text-align: center; }

.inner-main .banner{ margin: 0 auto; overflow: hidden; width: 6.9rem; height: 4.5rem; position: relative; }
.inner-main .banner .price-wrapper{ position: absolute; bottom: 0.59rem ; right: 0.56rem; color: #FFFFFF; }
.inner-main .banner .price-wrapper .formula{ font-size: 0.4rem; }
.inner-main .banner .price-wrapper .jiashu{ display: inline-block; min-width: 0.76rem; text-align: center; }
.inner-main .banner .price-wrapper .plus{ display: inline-block; margin:0 0.04rem; width:0.24rem;}
.inner-main .banner .price-wrapper .total-price { display: inline-block; min-width: 1.8rem; font-size: 0.72rem; text-align: center;}
.inner-main .banner .price-wrapper .symbol{ font-size: 0.32rem; }
.inner-main .banner .price-wrapper .explain{ line-height: 0.24rem; font-size: 0.24rem; }
.inner-main .banner .price-wrapper .explain .plus{ color: transparent; }
.inner-main .banner .price-wrapper .explain .total-price{ font-size: 0.24rem; }
 
.inner-main .redpocket-wrapper{ margin-top: 12px; padding: 0 0.24rem; }
.inner-main .redpocket { background: #FFFFFF; border: 1px solid #E1E1E1; border-radius: 0.08rem; height: 1.2rem; }
.inner-main .redpocket .icon{float: left; width: 0.48rem; height: 0.48rem; margin:0.36rem 0.24rem 0.36rem 0.32rem; }
.inner-main .redpocket .textwrapper{padding-top: 0.1px; float: left; height: 100%; width: 60%; overflow: hidden;}
.inner-main .redpocket .textwrapper .title{ margin: 0.25rem 0 0.16rem; font-size: 0.3rem; color: #323232; line-height: 0.3rem; }
.inner-main .redpocket .textwrapper .subtitle{font-size: 0.24rem; color: #888888; line-height: 0.24rem; width: 100%; height: 0.24rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
.inner-main .redpocket .sharebtn{margin:0.36rem 0.32rem 0.36rem  0; float: right; /*width: 58px;*/ padding: 0 0.1rem; height: 0.48rem; font-size: 0.28rem; color: #FF5252; line-height: 0.48rem; text-align: center; border: 1px solid #FF5252; border-radius: 0.08rem;}

.inner-main .other-wrapper{ padding: 0.16rem 0.24rem 0.4rem; }
.inner-main .other{ background: #FFFFFF; border: 1px solid #E1E1E1; border-radius: 0.08rem; height: 3.2rem; overflow: hidden; }
.inner-main .other .other-title{ margin: 0.26rem 0 0.16rem; padding-left: 0.3rem; font-size: 0.34rem; line-height: 0.48rem; color: #323232; letter-spacing: 0; font-weight: 600; }
.inner-main .other .swiper-container{ height: 1.98rem; }
.inner-main .other .swiper-container .active-list .active-item{ margin-left: 0.16rem; width: 2.64rem; height: 1.98rem; background: grey; border-radius: 0.08rem; overflow: hidden;}
.inner-main .other .swiper-container .active-list .active-item:first-child{ margin-left: 0.3rem; }
.inner-main .other .swiper-container .active-list .active-item a{ display: block; height: 100%; }
.inner-main .other .swiper-container .active-list .active-item img{ vertical-align: bottom; }  
    
.inner-bottom{ position: absolute; bottom: 0; width: 100%; height: 1.36rem; background: #F5F5F5; padding: 0.24rem; }
.inner-bottom .again-btn{ display: block; height: 0.88rem; background: #FF5252; border-radius: 0.08rem; color: #FFFFFF; font-size: 0.34rem; letter-spacing: 0; text-align: center; line-height: 0.88rem; font-weight: 600; }

.recharge_unknow img,.recharge_fail img{display: block;margin: 20% auto 0;}
.recharge_unknow p,.recharge_fail p{text-align: center;color: #888;font-size: 20px;margin-top: 30px;}
.recharge_unknow p a,.recharge_fail p a{color: #1e82e6;}
.recharge_unknow a.rebate_again,.recharge_fail a.rebate_again{font-size: 20px;text-align: center;color: #ec4949;height: 60px;line-height: 60px;border: 1px solid #ec4949;-webkit-box-sizing: border-box;box-sizing: border-box;background: #fff;width: 90%;display: block;position: absolute;bottom: 30px;margin:0 5%;} 
/*loading加载页*/
.loading{display: block;background-color: #f0f0f0;opacity:1;color: #888;font-size: 20px;text-align: center;margin:auto;}
.loading img{display: block;height:50px;width:50px;opacity:0.7;position: absolute;left: 50%;top: 50%;margin-left:-25px;margin-top:-25px;}
.loading p{display: block;height:50px;width:100%;position: absolute;top: 60%;}

	</style>
</head>
<body>
<div id="app" v-cloak>
	<div class="container" v-if="res_status===1">  <!--购卡成功-->
		<div class="inner-main">
			<section class="whitebg">
				<section class="result-wrapper">
					<div class="result-title">支付成功</div>
					<div class="result-subtitle">出行卡金额已到您的账户</div>
				</section>
				<section class="banner" v-show="local_params">
					<!--卡片背景-->
					<img  :src="local_params.tag_picture" width="100%" height="100%" />
					<!--购卡金额-->
					<section class="price-wrapper">
						<div v-if="local_params.percent>0">   <!--充值有返现-->
							<div class="formula">    <!--计算公式-->
								<span class="jiashu">{{local_params.amount}}</span><span class="plus">+</span><span class="jiashu">{{local_params.extra}}</span><span class="plus">=</span><span class="total-price">{{local_params.total}}</span><span class="symbol">元</span>
							</div>
							<div class="explain">
								<span class="jiashu">购买</span><span class="plus">+</span><span class="jiashu">赠送</span><span class="plus">=</span><span class="total-price">总计</span>
							</div>
						</div>
						<div v-if="local_params.percent==0">  <!--充值无返现-->
							<span class="total-price">{{local_params.amount}}</span> <span class="symbol">元</span>
						</div>
					</section>	
				</section>
			</section>
			<section class="redpocket-wrapper" v-if="red_obj.entry_title">   <!--红包裂变入口-->
				<div class="redpocket">
					<div class="icon"><img :src="red_obj.entry_icon" width="100%" height="100%"/></div>
			    		<div class="textwrapper">
			    			<div class="title">{{red_obj.entry_title}}</div>
			    			<div class="subtitle">{{red_obj.entry_subtitle}}</div>
			    		</div>
			    		<div id="sharebtn" class="sharebtn">{{red_obj.entry_sharebtn}}</div>  <!--去分享的按钮-->
				</div>
			</section>
			<section class="other-wrapper" v-if="actives.length>0">   <!--更多活动-->
				<div class="other">
					<div class="other-title">更多活动</div>
					<div class="swiper-container">
						<ul class="swiper-wrapper active-list" >
							<li class="swiper-slide active-item " v-for="active in actives">
								<a :href="active.redirect_url"><img :src="active.image_url" width="100%" height="100%"/></a>
							</li>
						</ul>
					</div>
				</div>
			</section>
		</div>
		<div class="inner-bottom"><a class="again-btn" :style="btn_style" href="/touch/rechargerebate/index">再次购买</a></div>
	</div>
	
	<section class="mask recharge_unknow" v-if="res_status===2">  <!-- 通信异常 -->
	    <img src="https://i1.yongche.name/media/g1/M01/06/15/rBEARFY7FnuIfX5xAAASm9Iv5oYAACh1wP_6mMAABKz686.png" alt="">
	    <p>网络通信异常</p>
	    <a class="rebate_again" href="/touch/rechargerebate/index">返回重试</a>
	</section>
	
	<section class="mask recharge_fail"  v-if="res_status===0"><!-- 充值失败 -->
	    <img src="https://i1.yongche.name/media/g1/M01/06/15/rBEARFY7FnuIfX5xAAASm9Iv5oYAACh1wP_6mMAABKz686.png" alt="">
	    <p>{{fail_desc}}</p>
	    <a class="rebate_again" href="/touch/rechargerebate/index">返回重试</a>
	</section>
	
	<div class="mask loading" v-show="loading">  <!--加载中页面-->
	    <img src="https://i1.yongche.name/media/g1/M01/06/16/rBEARFY8Xy2ID24xAABHEtelIYMAACiQAMX9E8AAEcq787.gif" alt="">
	    <p>数据请求中...</p>
	</div>
</div>
		

<script src='https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.16/vue.min.js'></script>	
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>-->	
<script src="https://unpkg.com/axios@0.18.0/dist/axios.min.js"></script>
<!--<script src="https://cdn.bootcss.com/Swiper/4.1.0/js/swiper.min.js"></script>-->
<script src="<{asset2:js/app/swiper/swiper3.07.min.js}>"></script>
<script type="text/javascript">
var rebateResult = new Vue({
  	el: '#app',
	data:{
		//Ad_host:'https://testing-marketapi.yongche.Org', //"更多活动"接口域名
		Ad_host:'https://marketapi.yongche.com',   // TODO
		res_status:'',   // 0--充值失败， 1--成功， 2--网络异常
		loading: true, //是否加载中
		fail_title: '购卡失败',
		fail_desc:'购卡未完成',
		timer:'',
		time_counter:0,
		recharge_amount:'',
		complete_params:'', //complete接口需要的参数
		local_params:'', //从localstorage中获取的参数
		red_obj:{},  //红包裂变相关信息
		actives:[],  //更多活动相关信息
		
		showToast:false,  //吐司提示框的展示与否  false-不展示，true-展示
	  	toastMsg:'' //吐司提示信息
	},
	computed:{
		btn_style:function(){
			var obj = {
				backgroundColor: this.local_params.color
			}
			return obj;
		}
	},
	mounted: function(){
	　　clearInterval(this.timer)
		this.init();
	},
	distroyed: function () {
	　　clearInterval(this.timer)
	},
	methods:{
		init:function (){
			var reqObj = this.getRequest();  //从URL中解析出参数
			this.complete_params = {
				transaction_id: reqObj.transaction_id, 
				is_joined: 0, 
				activity_id: reqObj.activity_id,
				project_id: reqObj.project_id
			}
			this.timer = setInterval(this.getRechargeResult,2000); 
        },
        getRechargeResult:function(){ //检测登录状态
        		var vm = this;
			axios.post('/ajax/Rechargerebate/complete', vm.complete_params)
			.then(function (response) {
			   	var data = response.data;
				console.log(data);
				vm.time_counter++;
				if(vm.time_counter>3){
					clearInterval(vm.timer);
					vm.loading = false;
				}
				if(data){
					vm.dealData(data)
				}
			})
			.catch(function (error) {
				document.title = vm.fail_title;
			    console.log(error);
			});
        },
        dealData:function(data){// res_status:'',   //-1--加载中， 0--充值失败， 1--成功， 2--网络异常
        		var code = data.code;
        		var result = data.result;
        		if (code == "617") {
                document.title = this.fail_title;
                alert("您尚未登录，请登录后再购卡");
                window.location.href = "yongche://login";
            } else if (code == "200") {   //交易成功
				this.getOrderCompleteAd();   //获取“更多活动”的数据
                clearInterval(this.timer);
                this.loading = false;
                this.res_status = 1;
                this.recharge_amount = result.recharge_amount;  //充值金额
                this.complete_params.recharge_amount = result.recharge_amount;  //获取红包裂变接口需要增加充值金额这个参数
                this.getLocalStorage();  //获取购买页存储的参数信息 
                this.getRedPocket();   //获取红包裂变配置信息
            } else if (code == "618") { //交易失败或交易中
               	if (this.time_counter > 1) {
                    clearInterval(this.timer);
                    this.loading = false;
                }
               	this.res_status = 0;
            } else if (code == "619") {//交易失败
                document.title = this.fail_title;
                clearInterval(this.timer);
                this.res_status = 0;
                this.fail_desc = "购卡未完成" + data.msg;
                this.loading = false;
            } else {
                document.title = this.fail_title;
                clearInterval(this.timer);
                this.res_status = 2;
            }
        },
        getRedPocket:function(){    //获取红包裂变配置信息
        		var vm = this;
		    axios.post('/ajax/Rechargerebate/completeExtInfo', vm.complete_params)
			.then(function (response) {
			    var data = response.data;
				console.log(data);
				if(data && data.code == 200){
	        			var result = data.result;
	        			if(result.results_page && result.results_page.red_packets){
	                		var red_obj = result.results_page.red_packets;
	                		if(red_obj.shareTitle){//红包裂变入口开放
	                			vm.red_obj = red_obj;  //红包裂变入口相关配置文案
	                			vm.redStatAction(red_obj.redStatUrl,1);  //可能是数据埋点用的  
			                setShareInfo('sharebtn',red_obj);
	                		}
	                }
	        		}else if(data.code == 600){  //参数错误
	        			console.log('红包裂变接口参数错误')
	        		}
			})
			.catch(function (error) {
			    console.log(error);
			});
        },
        getOrderCompleteAd:function(){  //获取“更多活动”的数据
        		var vm = this;
			axios.get(vm.Ad_host + '/User/Advertisement/getOrderCompleteAd')
			.then(function (response) {
				var data = response.data;
				if(data && data.code==200 && data.result){
	                 var res = data.result;
	        			if(res.count>0){
	        				vm.actives = res.list;
	        				vm.$nextTick(function(){
							vm.initSwiper(); //初始化轮播图
						})
	        			}
                }
			})
			.catch(function (error) {
				document.title = vm.fail_title;
				console.log(error);
			});
        },
        initSwiper:function(){  //初始化轮播图
	        	var sw = new Swiper(".swiper-container", {
				slidesPerView: 'auto'
	        });
        },
		showToastFn:function(msg,cb){  //toast提示
			var vm = this;
			vm.showToast = true;
     		vm.toastMsg = msg;
     		setTimeout(function(){
     			vm.showToast = false;
     			if(cb){ cb(); }
     		},2000)
		},
        getRequest:function () {
	        var url = location.search; //获取url中"?"符后的字串
	        var theRequest = new Object();
	        if (url.indexOf("?") != -1) {
	            var str = decodeURIComponent(url.substr(1));
	            var strs = str.split("&");
	            for (var i = 0; i < strs.length; i++) {
	                theRequest[strs[i].split("=")[0]] = strs[i].split("=")[1];
	            }
	        }
	        return theRequest;
	    },
		getLocalStorage:function(){     //获取本地存储，为结果页留存所需信息
			var str = window.localStorage.getItem("params");
			if(!str){
				console.log('localStorage没有存储购卡信息');
				return
			}
			this.local_params = JSON.parse(str);
		},
        redStatAction:function(redStatUrl,num){  //可能是数据埋点用的，对该接口返回数据没有任何处理
			axios.get(redStatUrl+'&action='+num)
			.then(function (response) {
				console.log('done');
			})
			.catch(function (error) {
				console.log(error);
			});
        }
  	}
})	
</script>
<script>
    function setShareInfo(dom,shareInfo) {
        var _protocolLink = "yongche://share?";
        var _protocolLinkFriend = "yongche://shareToFriend?";
        var _protocolLinkTimeline = "yongche://shareToTimeline?";

        // 分享地址
        var shareRead_link = encodeURIComponent(shareInfo.shareUrl);
        // 分享的图片
        var shareRead_pics = encodeURIComponent(shareInfo.icon);

        // 分享的标题
        var shareRead_title = encodeURIComponent(shareInfo.shareTitle);
        // 分享的内容
        var shareRead_content = encodeURIComponent(shareInfo.subTitle);
        // 分享的需要生成二维码地址
        var shareRead_codeUrl = encodeURIComponent("://m.yongche.com");
        var shareRead_sourceType = 42; //1-截图分享 42-图文分享
        var shareRead_callback = "share_callback";

        var Tools = {
            shareThisPage:function(){
                if(shareInfo.redStatUrl){
                		rebateResult.redStatAction(shareInfo.redStatUrl,2);
                }
                var _str = "link="+shareRead_link+"&pics="+shareRead_pics+"&title="+shareRead_title+"&content="+shareRead_content+"&sourceType="+shareRead_sourceType+"&callback="+shareRead_callback+"&codeUrl="+shareRead_codeUrl;
                var _tmpOpenLink = _protocolLink + _str;
                window.location.href = _tmpOpenLink;
            }

        };

        //dom.click=Tools.shareThisPage();
        /*端内分享，页面分享按钮点击*/
       setTimeout(function(){
       	document.getElementById(dom).addEventListener("click", function(){
	        ga('send', 'event', 'share_button', 'click', 'shareClickRecharge');
	        Tools.shareThisPage();
	    });
       },1000)
	    
    }
</script>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-18761483-4', 'auto');  ga('send', 'pageview');
</script>
</body>
</html>
